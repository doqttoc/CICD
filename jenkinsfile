pipeline{
    agent any
    // parameters {
    //     string(name: 'VERSION', defaultValue: '1.0', description: 'Version number')
    // }
    tools {nodejs "node_latest_version"}
    stages{
        stage('Checkout') {
            steps {
                // 检出代码
                checkout scm
            }
        }
        stage('Build'){
            steps{
                echo "hello world"
                echo "1111"
                echo "docker --version"
                echo "hello jenkins"
                script {
                    def prNumber = env.CHANGE_ID
                    def prBranch = env.CHANGE_BRANCH
                    def prAuthor = env.CHANGE_AUTHOR
                    def containerName = 'pipeline-007'
                    
                    echo "Pull Request Number: ${prNumber}"
                    echo "Pull Request Branch: ${prBranch}"
                    echo "Pull Request Author: ${prAuthor}"
                    sh '''
                        docker --version
                        node --version
                        npm --version
                        npm cache clean --force
                        npm config set registry https://registry.npmmirror.com
                        npm config get registry
                        rm -rf package-lock.json
                        npm install
                        npm run build
                        docker image ls
                    '''
                    sh " docker build -t pipeline-pr-${prNumber} ."
                    sh " docker image ls"
                    sh "docker rm -f ${containerName}"
                    sh "docker run --name ${containerName} -d -p 8022:80 pipeline-pr-${prNumber}"
                }
                
            }
        }
        
        stage('DOCKER CONTAINER STATUS'){
            steps{
                echo "show  docker container status "
                sh ''' 
                    docker images
                    docker ps -a
                '''
            }
        }
    }
    
}